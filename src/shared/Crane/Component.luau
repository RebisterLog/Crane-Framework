--[[
 ██████╗██████╗  █████╗ ███╗   ██╗███████╗
██╔════╝██╔══██╗██╔══██╗████╗  ██║██╔════╝
██║     ██████╔╝███████║██╔██╗ ██║█████╗
██║     ██╔══██╗██╔══██║██║╚██╗██║██╔══╝
╚██████╗██║  ██║██║  ██║██║ ╚████║███████╗
╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝

███████╗██████╗  █████╗ ███╗   ███╗███████╗██╗    ██╗ ██████╗ ██████╗ ██╗  ██╗
██╔════╝██╔══██╗██╔══██╗████╗ ████║██╔════╝██║    ██║██╔═══██╗██╔══██╗██║ ██╔╝
█████╗  ██████╔╝███████║██╔████╔██║█████╗  ██║ █╗ ██║██║   ██║██████╔╝█████╔╝
██╔══╝  ██╔══██╗██╔══██║██║╚██╔╝██║██╔══╝  ██║███╗██║██║   ██║██╔══██╗██╔═██╗
██║     ██║  ██║██║  ██║██║ ╚═╝ ██║███████╗╚███╔███╔╝╚██████╔╝██║  ██║██║  ██╗
╚═╝     ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚═╝╚══════╝ ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝
by RebisterLog
]]

--!strict
--!optimize 2

local Signal = require(script.Parent.packages.Signal)
local Log = require(script.Parent.Utils).Log

--[=[
	The Component module provides the base class for all components in the Crane framework.

	Components are reusable pieces of functionality that can be attached to Roblox instances.
	They support lifecycle callbacks, automatic cleanup, and can be automatically instantiated
	via CollectionService tags.

	@class Component
]=]
local Component = {}
Component.__index = Component
Component.__tostring = "CraneComponent"

-- Types
--[=[
	Configuration table for creating a new component.

	@type ComponentDef
	@within Component
]=]
export type ComponentDef<T = {any}?> = {
	--[=[
		The unique name of the component.

		@prop Name string
		@within ComponentDef
	]=]
    Name: string,
	--[=[
		Optional CollectionService tag for automatic component instantiation.

		@prop Tag string?
		@within ComponentDef
	]=]
    Tag: string?,
	--[=[
		Optional base table to extend with component functionality.

		@prop BaseComponent T
		@within ComponentDef
	]=]
    BaseComponent: T,
}

--[=[
	Internal data structure for component instances.

	@type ComponentData
	@within Component
]=]
export type ComponentData<T> = ComponentDef & {
	--[=[
		The Roblox instance this component is attached to.

		@prop instance T
		@readonly
		@within ComponentData
	]=]
	instance: T,
	--[=[
		Signal that fires when the component is being destroyed.

		@prop Destroying Signal.Signal<nil>
		@readonly
		@within ComponentData
	]=]
	Destroying: Signal.Signal<nil>,
	--[=[
		Optional callback function that is called when the component starts.

		@prop onStart ((self: Component<T>) -> ())?
		@within ComponentData
	]=]
    onStart: ((self: Component<T>) -> ())?,
}

--[=[
	Represents a component instance in the Crane framework.

	@type Component
	@within Component
]=]
export type Component<T = Instance> = setmetatable<ComponentData<T>, typeof(Component)>

--[=[
	Creates a new component definition. This is typically called by `Crane:CreateComponent`.

	```lua
	local component = Component.new({
		Name = "MyComponent",
		Tag = "MyComponentTag",
		BaseComponent = {},
	})
	```

	@method new
	@param options ComponentDef<T>
	@return Component<T>
	@within Component
]=]
function Component.new<T>(options: ComponentDef<T>)
    local self = (options.BaseComponent or {}) :: ComponentDef<T>
    self.Name = options.Name
    self.Tag = options.Tag

    return setmetatable(self, Component) :: Component & T
end

--[=[
	Creates a new instance of this component attached to a specific Roblox instance.

	This method is typically called by `Crane:AddComponent` and should not be called directly in most cases.

	```lua
	local componentInstance = component:Instantiate(workspace.Part)
	```

	@method Instantiate
	@param instance T & Instance
	@return Component<T>
	@within Component
]=]
function Component.Instantiate<T>(self: Component<T>, instance: T & Instance)
	local prototype = setmetatable({
		instance = instance,
		Destroying = Signal.new(),
	}, {
		__index = self
	})
	
	instance.Destroying:Connect(function()
		self.Destroying:Fire()
	end)

	return prototype :: Component<T>
end

--[=[
	Destroys the component instance, firing the Destroying signal and cleaning up resources.

	```lua
	component:Destroy()
	```

	@method Destroy
	@within Component
]=]
function Component.Destroy<T>(self: Component<T>)
    self.Destroying:Fire()
end

--[=[
	Starts the component by calling the `onStart` callback if it exists.

	This method is automatically called by `Crane:AddComponent` and should not be called manually in most cases.

	If `CRANE_DEBUGGING` is enabled, errors are caught and logged instead of being thrown.

	@method Start
	@within Component
]=]
function Component.Start<T>(self: Component<T>)
	if not self.onStart then return end

	if _G["CRANE_DEBUGGING"] then
		local success, err = pcall(self.onStart, self)

		if not success then
			Log(self.Name, err, "warn")
		else
			Log(self.Name, "Successfully started")
		end
	else
		self:onStart()
	end
end

return Component
